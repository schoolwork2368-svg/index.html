<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Toolkit</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic components -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom spinner utility */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans p-4 sm:p-6">
    <div class="max-w-4xl mx-auto">
        <header class="text-center py-6">
            <h1 class="text-3xl font-bold text-gray-900 flex items-center justify-center space-x-2">
                <!-- Icon for Image Toolkit -->
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-8 w-8 text-indigo-600"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                <span>AI Image Toolkit</span>
            </h1>
            <p class="text-gray-500 mt-2">Generate new images or analyze existing ones with Gemini.</p>
        </header>

        <!-- Tabs -->
        <div class="bg-white p-1 rounded-xl shadow-lg border border-gray-100 mb-6">
            <div class="flex justify-between">
                <button id="tab-generate"
                    class="flex-1 flex items-center justify-center py-3 px-4 text-lg font-medium rounded-xl transition-all duration-300 bg-indigo-500 text-white shadow-md"
                    onclick="setActiveTab('generate')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8-.4.7-1.1 1.2-2.1 1.6-1.5.6-3 1.2-4.4 2.1-1.3.8-2.6 1.7-3.8 2.8-.7.7-1.2 1.6-1.4 2.6L7.3 18c-.3.8-.4 1.4-.4 2.1 0 1.2.9 2.1 2.1 2.1Z"/><path d="M14.5 12.5 16 11"/><path d="m8 8 2 2"/><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8"/><path d="m14 11 1.5-1.5"/></svg>
                    Generate Image
                </button>
                <button id="tab-analyze"
                    class="flex-1 flex items-center justify-center py-3 px-4 text-lg font-medium rounded-xl transition-all duration-300 text-gray-600 hover:bg-gray-50"
                    onclick="setActiveTab('analyze')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                    Analyze Image
                </button>
            </div>
        </div>

        <!-- Error Display -->
        <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert">
            <span class="font-medium">Error:</span> <span id="error-text"></span>
        </div>

        <!-- --- Image Generation Tab Content --- -->
        <div id="content-generate" class="space-y-6">
            <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100">
                <label for="generation-prompt" class="block text-sm font-medium text-gray-700 mb-2">Image Prompt</label>
                <textarea id="generation-prompt" rows="3"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Describe the image you want to create (e.g., A golden retriever wearing sunglasses on a skateboard in Miami).">A futuristic city skyline at sunset, cyberpunk aesthetic, detailed digital art.</textarea>
                <button id="generate-button" onclick="handleGenerateImage()"
                    class="mt-3 w-full flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 transition duration-150">
                    <span id="generate-icon-text" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8-.4.7-1.1 1.2-2.1 1.6-1.5.6-3 1.2-4.4 2.1-1.3.8-2.6 1.7-3.8 2.8-.7.7-1.2 1.6-1.4 2.6L7.3 18c-.3.8-.4 1.4-.4 2.1 0 1.2.9 2.1 2.1 2.1Z"/><path d="M14.5 12.5 16 11"/><path d="m8 8 2 2"/><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8"/><path d="m14 11 1.5-1.5"/></svg>
                        Generate Image
                    </span>
                </button>
            </div>

            <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100 min-h-[300px] flex flex-col items-center justify-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 w-full">Generated Output</h3>
                <div id="generated-image-output" class="text-center text-gray-400 p-8 w-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                    <p>Your generated image will appear here.</p>
                </div>
            </div>
        </div>

        <!-- --- Image Analysis Tab Content (Initially Hidden) --- -->
        <div id="content-analyze" class="space-y-6 hidden">
            <!-- Image Upload Area -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Image</label>
                <input type="file" id="image-upload" accept="image/*" onchange="handleImageUpload(event)"
                    class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                
                <div id="image-preview-container" class="mt-4 hidden flex-col items-center">
                    <h4 class="text-md font-medium text-gray-700 mb-2">Uploaded Image Preview:</h4>
                    <img id="uploaded-image-preview" alt="Uploaded" class="max-h-64 max-w-full h-auto rounded-lg border border-gray-300 shadow-lg">
                </div>
            </div>

            <!-- Analysis Prompt and Button -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100">
                <label for="analysis-prompt" class="block text-sm font-medium text-gray-700 mb-2">Your Question</label>
                <textarea id="analysis-prompt" rows="2"
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
                    placeholder="What do you want to know about this image?">Describe this image in detail and suggest a creative caption.</textarea>
                <button id="analyze-button" onclick="handleAnalyzeImage()" disabled
                    class="mt-3 w-full flex items-center justify-center px-4 py-2 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-green-600 hover:bg-green-700 disabled:opacity-50 transition duration-150">
                    <span id="analyze-icon-text" class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                        Analyze Image
                    </span>
                </button>
            </div>

            <!-- Analysis Result -->
            <div class="bg-white p-4 rounded-xl shadow-md border border-indigo-100 min-h-[150px]">
                <h3 class="text-lg font-semibold text-gray-800 mb-4 w-full">Analysis Result</h3>
                <div id="analysis-result-output" class="text-center text-gray-400 p-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8-.4.7-1.1 1.2-2.1 1.6-1.5.6-3 1.2-4.4 2.1-1.3.8-2.6 1.7-3.8 2.8-.7.7-1.2 1.6-1.4 2.6L7.3 18c-.3.8-.4 1.4-.4 2.1 0 1.2.9 2.1 2.1 2.1Z"/></svg>
                    <p>The AI's description or answer will appear here after analysis.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables provided by the environment
        const apiKey = ""; // Canvas will inject the key
        const BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';

        // --- State Management and UI References ---
        let activeTab = 'generate';
        let isLoading = false;
        let uploadedImageBase64 = null;
        let uploadedImageMimeType = null;

        // UI Element References
        const ui = {
            errorDiv: document.getElementById('error-message'),
            errorText: document.getElementById('error-text'),
            tabGenerate: document.getElementById('tab-generate'),
            tabAnalyze: document.getElementById('tab-analyze'),
            contentGenerate: document.getElementById('content-generate'),
            contentAnalyze: document.getElementById('content-analyze'),
            generationPrompt: document.getElementById('generation-prompt'),
            generateButton: document.getElementById('generate-button'),
            generateIconText: document.getElementById('generate-icon-text'),
            generatedImageOutput: document.getElementById('generated-image-output'),
            imageUpload: document.getElementById('image-upload'),
            imagePreviewContainer: document.getElementById('image-preview-container'),
            uploadedImagePreview: document.getElementById('uploaded-image-preview'),
            analysisPrompt: document.getElementById('analysis-prompt'),
            analyzeButton: document.getElementById('analyze-button'),
            analyzeIconText: document.getElementById('analyze-icon-text'),
            analysisResultOutput: document.getElementById('analysis-result-output'),
        };

        // --- Utility Functions ---

        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // Only data part
                reader.onerror = (error) => reject(error);
            });
        };

        const exponentialBackoffFetch = async (url, options, retries = 5) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        if (response.status !== 429) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        console.warn(`Attempt ${i + 1}: Rate limit exceeded (429). Retrying in ${Math.pow(2, i)}s...`);
                    } else {
                        return response;
                    }
                } catch (error) {
                    if (i === retries - 1) {
                        throw error;
                    }
                    console.error(`Attempt ${i + 1}: Fetch error:`, error.message, 'Retrying...');
                }
                await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
            }
            throw new Error("API request failed after multiple retries.");
        };

        // --- UI Updates ---

        const updateLoadingState = (loading, buttonId, defaultText, isGenerate) => {
            isLoading = loading;
            const button = document.getElementById(buttonId);
            const iconText = document.getElementById(isGenerate ? 'generate-icon-text' : 'analyze-icon-text');

            if (!button || !iconText) return;

            button.disabled = loading || (buttonId === 'analyze-button' && !uploadedImageBase64);
            ui.generationPrompt.disabled = loading;
            ui.analysisPrompt.disabled = loading;
            ui.imageUpload.disabled = loading;

            if (loading) {
                iconText.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2 animate-spin"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9z"/></svg> ${defaultText.replace('Image', 'ing Image...')}`;
            } else {
                const iconSvg = isGenerate
                    ? `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8-.4.7-1.1 1.2-2.1 1.6-1.5.6-3 1.2-4.4 2.1-1.3.8-2.6 1.7-3.8 2.8-.7.7-1.2 1.6-1.4 2.6L7.3 18c-.3.8-.4 1.4-.4 2.1 0 1.2.9 2.1 2.1 2.1Z"/><path d="M14.5 12.5 16 11"/><path d="m8 8 2 2"/><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8"/><path d="m14 11 1.5-1.5"/></svg>`
                    : `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 mr-2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>`;
                iconText.innerHTML = `${iconSvg} ${defaultText}`;
            }
        };

        const updateError = (message) => {
            if (message) {
                ui.errorText.textContent = message;
                ui.errorDiv.classList.remove('hidden');
            } else {
                ui.errorDiv.classList.add('hidden');
            }
        };

        const setActiveTab = (tab) => {
            activeTab = tab;
            updateError(null);

            // Tab Buttons
            ui.tabGenerate.classList.remove('bg-indigo-500', 'text-white', 'shadow-md', 'bg-green-500');
            ui.tabAnalyze.classList.remove('bg-indigo-500', 'text-white', 'shadow-md', 'bg-green-500');
            ui.tabGenerate.classList.add('text-gray-600', 'hover:bg-gray-50');
            ui.tabAnalyze.classList.add('text-gray-600', 'hover:bg-gray-50');

            // Content Visibility
            if (tab === 'generate') {
                ui.tabGenerate.classList.add('bg-indigo-500', 'text-white', 'shadow-md');
                ui.contentGenerate.classList.remove('hidden');
                ui.contentAnalyze.classList.add('hidden');
            } else {
                ui.tabAnalyze.classList.add('bg-green-500', 'text-white', 'shadow-md');
                ui.contentAnalyze.classList.remove('hidden');
                ui.contentGenerate.classList.add('hidden');
            }
        };

        // --- Image Generation Logic ---

        const handleGenerateImage = async () => {
            const prompt = ui.generationPrompt.value.trim();
            if (!prompt) {
                updateError('Please enter a prompt to generate an image.');
                return;
            }

            updateError(null);
            updateLoadingState(true, 'generate-button', 'Generate Image', true);
            ui.generatedImageOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3 animate-spin"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9z"/></svg><p>Generating image... this may take a moment.</p></div>`;


            try {
                const url = `${BASE_URL}imagen-3.0-generate-002:predict?key=${apiKey}`;
                const payload = {
                    instances: { prompt: prompt },
                    parameters: { "sampleCount": 1 }
                };

                const response = await exponentialBackoffFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    const base64Data = result.predictions[0].bytesBase64Encoded;
                    const imageUrl = `data:image/png;base64,${base64Data}`;
                    ui.generatedImageOutput.innerHTML = `<img src="${imageUrl}" alt="Generated by AI" class="max-w-full h-auto rounded-lg shadow-xl border border-gray-200" />`;
                } else {
                    updateError('Image generation failed: Could not retrieve image data.');
                    ui.generatedImageOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M2 13C2 17.4183 5.58172 21 10 21C14.4183 21 18 17.4183 18 13C18 8.58172 14.4183 5 10 5C5.58172 5 2 8.58172 2 13Z"/><path d="M18 13H22V21H18V13Z"/></svg><p>Image generation failed. See error message above.</p></div>`;
                }
            } catch (err) {
                updateError(`Failed to generate image: ${err.message}. Check console for details.`);
                ui.generatedImageOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M2 13C2 17.4183 5.58172 21 10 21C14.4183 21 18 17.4183 18 13C18 8.58172 14.4183 5 10 5C5.58172 5 2 8.58172 2 13Z"/><path d="M18 13H22V21H18V13Z"/></svg><p>Image generation failed. See error message above.</p></div>`;
                console.error(err);
            } finally {
                updateLoadingState(false, 'generate-button', 'Generate Image', true);
            }
        };

        // --- Image Upload/Analysis Logic ---

        const handleImageUpload = async (event) => {
            const file = event.target.files?.[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                updateError('Please upload a valid image file.');
                return;
            }

            updateError(null);
            ui.analyzeButton.disabled = true;
            ui.analysisResultOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M10 21.5c.3 0 .5-.1.8-.4l3-3c.5-.5.9-1.2 1.2-2.3L20.6 8c.9-2.3 2-6.4 0-8-.4.7-1.1 1.2-2.1 1.6-1.5.6-3 1.2-4.4 2.1-1.3.8-2.6 1.7-3.8 2.8-.7.7-1.2 1.6-1.4 2.6L7.3 18c-.3.8-.4 1.4-.4 2.1 0 1.2.9 2.1 2.1 2.1Z"/></svg><p>The AI's description or answer will appear here after analysis.</p></div>`;


            try {
                const base64Data = await fileToBase64(file);
                uploadedImageBase64 = base64Data;
                uploadedImageMimeType = file.type;

                // Show preview
                ui.uploadedImagePreview.src = URL.createObjectURL(file);
                ui.imagePreviewContainer.classList.remove('hidden');

                ui.analyzeButton.disabled = false;

            } catch (err) {
                updateError('Failed to process image file.');
                uploadedImageBase64 = null;
                ui.imagePreviewContainer.classList.add('hidden');
                console.error(err);
            }
        };

        const handleAnalyzeImage = async () => {
            const prompt = ui.analysisPrompt.value.trim();
            if (!uploadedImageBase64 || !prompt) {
                updateError('Please upload an image and enter a question before analyzing.');
                return;
            }

            updateError(null);
            updateLoadingState(true, 'analyze-button', 'Analyze Image', false);
            ui.analysisResultOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3 animate-spin"><path d="M21 12a9 9 0 0 1-9 9 9 9 0 0 1-9-9z"/></svg><p>Analyzing image...</p></div>`;


            try {
                // Using gemini-2.5-flash-preview-09-2025 for Multimodal analysis
                const url = `${BASE_URL}gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
                
                const imagePart = {
                    inlineData: {
                        mimeType: uploadedImageMimeType,
                        data: uploadedImageBase64,
                    }
                };
                const textPart = { text: prompt };

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [textPart, imagePart]
                    }],
                };

                const response = await exponentialBackoffFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    ui.analysisResultOutput.innerHTML = `<div class="prose max-w-none"><p>${text.replace(/\n/g, '<br>')}</p></div>`;
                } else {
                    updateError('Analysis failed: Could not retrieve a valid response.');
                    ui.analysisResultOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M2 13C2 17.4183 5.58172 21 10 21C14.4183 21 18 17.4183 18 13C18 8.58172 14.4183 5 10 5C5.58172 5 2 8.58172 2 13Z"/><path d="M18 13H22V21H18V13Z"/></svg><p>Analysis failed. See error message above.</p></div>`;
                    console.error("API response error:", result);
                }
            } catch (err) {
                updateError(`Failed to analyze image: ${err.message}. Check console for details.`);
                ui.analysisResultOutput.innerHTML = `<div class="text-center text-gray-400 p-8"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto h-12 w-12 mb-3"><path d="M2 13C2 17.4183 5.58172 21 10 21C14.4183 21 18 17.4183 18 13C18 8.58172 14.4183 5 10 5C5.58172 5 2 8.58172 2 13Z"/><path d="M18 13H22V21H18V13Z"/></svg><p>Analysis failed. See error message above.</p></div>`;
                console.error(err);
            } finally {
                updateLoadingState(false, 'analyze-button', 'Analyze Image', false);
            }
        };

        // Initialize the UI on page load
        document.addEventListener('DOMContentLoaded', () => {
            setActiveTab('generate');
        });
    </script>
</body>
</html>